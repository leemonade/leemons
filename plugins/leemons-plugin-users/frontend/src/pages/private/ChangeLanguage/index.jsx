import React from 'react';
import { map } from 'lodash';
import PropTypes from 'prop-types';
import {
  Button,
  ContextContainer,
  Select,
  Box,
  Stack,
  TotalLayoutContainer,
  TotalLayoutFooterContainer,
  TotalLayoutHeader,
  TotalLayoutStepContainer,
} from '@bubbles-ui/components';
import { SettingsIcon } from '@bubbles-ui/icons/solid';
import { useStore } from '@common';
import { addErrorAlert, addSuccessAlert } from '@layout/alert';
import SocketIoService from '@mqtt-socket-io/service';
import useTranslateLoader from '@multilanguage/useTranslateLoader';
import prefixPN from '@users/helpers/prefixPN';
import { getPlatformLocalesRequest, updateUserRequest } from '@users/request';
import { useHistory } from 'react-router-dom';

function HeaderIcon() {
  return (
    <svg width="24" height="24" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M1.83443 0.54191C1.50051 0.574508 1.20735 0.715376 0.961268 0.961454C0.699584 1.22314 0.574016 1.49843 0.53933 1.88647C0.526604 2.02894 0.522393 3.6954 0.526317 7.02924C0.531771 11.6496 0.534111 11.9686 0.563487 12.0782C0.685887 12.5351 0.959775 12.877 1.35563 13.067C1.65853 13.2124 1.45935 13.2013 3.87455 13.2076C5.55793 13.212 6.03018 13.218 6.03061 13.2352C6.03091 13.2473 5.96055 13.6632 5.87422 14.1594L5.7173 15.0616L5.50917 15.0704C5.27128 15.0806 5.19262 15.106 5.08739 15.2066C4.83429 15.4487 4.90212 15.8589 5.22005 16.009C5.29984 16.0467 5.31725 16.0472 6.39005 16.0472C6.75012 16.0472 6.73067 16.0465 6.81005 16.0096C7.00042 15.9211 7.1003 15.7677 7.1003 15.5639C7.1003 15.4203 7.05843 15.3158 6.96246 15.2198C6.83255 15.0923 6.77145 15.0704 6.68391 15.0704C6.68391 15.0704 6.71405 15.0596 6.71405 15.0558C6.71405 15.0433 7.0201 13.2939 7.0295 13.2527C7.03861 13.2128 6.73992 13.2076 7.0295 13.2076C7.0295 13.2076 6.99513 13.1946 7.11236 13.0942C7.33065 12.9074 7.33509 12.5567 7.12165 12.3643C6.97232 12.2297 7.22103 12.24 4.76105 12.2354C1.88276 12.2312 1.881 12.2312 1.79985 12.1937C1.70202 12.1484 1.6147 12.0643 1.56085 11.9636L1.52105 11.8892L1.51642 6.90376C1.5112 1.28279 1.49722 1.81336 1.65477 1.6558C1.81368 1.4969 1.10046 1.51224 8.32759 1.51224C14.6897 1.51224 14.7415 1.51252 14.8366 1.54813C14.9391 1.58645 15.04 1.67773 15.0956 1.78224C15.1278 1.84291 15.1294 1.98177 15.1381 5.53524C15.1466 7.53796 15.1487 7.72889 15.1794 7.79724C15.2201 7.8876 15.3232 7.99556 15.4171 8.04594C15.4735 8.07627 15.5201 8.08461 15.6331 8.08461C15.8029 8.08461 15.8849 8.04961 15.9915 7.93155C16.1315 7.77666 16.1191 8.15851 16.1191 5.50824V1.79124L16.0784 1.63888C16 1.34458 15.8643 1.11832 15.645 0.91622C15.4502 0.736634 15.2463 0.628166 14.9794 0.56207C14.8686 0.534638 14.3467 0.532046 8.42405 0.529544C4.8848 0.528032 1.91946 0.533612 1.83443 0.54191ZM6.80394 2.46505C6.66387 2.50765 6.54206 2.62194 6.48921 2.7603C6.44281 2.88182 6.45766 3.08005 6.52048 3.17736C6.59286 3.28952 7.432 4.11397 7.51912 4.15851C7.61166 4.20585 7.80732 4.21173 7.90675 4.17019C8.00623 4.12863 8.12716 4.00662 8.17187 3.90267C8.22013 3.7905 8.21647 3.6141 8.16355 3.50124C8.14242 3.45616 7.9644 3.26302 7.68742 2.98469C7.19483 2.48969 7.13629 2.44735 6.94805 2.44996C6.8936 2.45072 6.82875 2.45751 6.80394 2.46505ZM4.46394 4.80496C4.34842 4.84035 4.24371 4.92529 4.17159 5.04214C4.10815 5.14487 4.10106 5.38375 4.15827 5.49063C4.19655 5.56218 4.30794 5.67249 4.38183 5.71203C4.45197 5.74958 4.48146 5.75161 5.08311 5.76024L5.71116 5.76924L5.76115 5.96724C5.91953 6.59466 6.24762 7.17604 6.78774 7.78635C6.89853 7.91152 6.9814 8.01918 6.97192 8.02559C6.50728 8.33917 5.9772 8.6022 5.44258 8.78445C5.1361 8.88894 5.09758 8.90795 5.02506 8.99055C4.94244 9.08467 4.91126 9.15534 4.90062 9.27272C4.87542 9.55051 5.06494 9.77542 5.34844 9.80421C5.42957 9.81245 5.48256 9.80181 5.67905 9.7379C6.35632 9.51756 7.01049 9.19271 7.56509 8.8013C7.66256 8.73252 7.75004 8.67624 7.75945 8.67624C7.76889 8.67624 7.83115 8.71575 7.89782 8.76402C7.89782 8.76402 7.75805 8.62281 8.2768 8.99196C8.47983 9.05818 8.52429 9.06682 8.61434 9.05757C8.79105 9.0394 8.93098 8.94766 9.006 8.80078C9.04251 8.72932 9.05062 8.68718 9.05062 8.56941C9.05062 8.44481 9.04396 8.41409 9.00125 8.34142C8.92164 8.20599 8.73431 8.15338 8.62512 8.11805C8.51594 8.08273 8.53801 8.02141 8.5343 8.01798C8.53057 8.01454 8.60608 7.92432 8.7021 7.81747C9.05382 7.42608 9.30164 7.06725 9.49512 6.66924C9.6307 6.39036 9.68913 6.23266 9.75526 5.96724L9.8046 5.76924L10.4328 5.76024C11.1321 5.75021 11.1144 5.75325 11.256 5.61876C11.342 5.53707 11.3749 5.4754 11.3928 5.36182C11.4269 5.14636 11.3248 4.93983 11.1331 4.83615L11.0611 4.79724L7.78505 4.79418C5.98325 4.7925 4.48875 4.79736 4.46394 4.80496ZM6.73205 5.79692C6.73205 5.841 6.83479 6.11127 6.90332 6.24746C7.07623 6.59103 7.28298 6.87809 7.60901 7.22724L7.76028 7.38924L7.87669 7.26324C8.19914 6.91418 8.36955 6.68841 8.53536 6.39047C8.64516 6.19321 8.78405 5.86208 8.78405 5.79759V5.76024H7.75805C6.73772 5.76024 6.73205 5.76043 6.73205 5.79692Z"
        fill="currentColor"
      />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M12.7143 7.52494C12.2752 7.60403 11.8609 7.92741 11.6817 8.33084C11.6581 8.38396 11.5604 8.68376 11.4646 8.99708C11.3689 9.31039 11.2794 9.58364 11.2659 9.60431C11.2349 9.65146 11.1663 9.68323 11.0954 9.68323C11.0654 9.68323 10.7924 9.62497 10.4888 9.55375L9.93675 9.42427L9.66675 9.42444C9.41837 9.42461 9.38521 9.4286 9.25275 9.47439C8.85821 9.61078 8.59833 9.83066 8.40585 10.1909C8.29022 10.4073 8.24999 10.5751 8.25037 10.8392C8.25073 11.0882 8.28833 11.2598 8.38765 11.4654C8.47144 11.6388 8.54087 11.7242 8.99193 12.2085C9.20469 12.437 9.38962 12.6495 9.40291 12.6808C9.44969 12.7911 9.41781 12.8389 8.99722 13.2893C8.52114 13.799 8.48442 13.8446 8.38634 14.0472C8.28633 14.2538 8.2494 14.4237 8.25001 14.6744C8.25181 15.4021 8.78322 15.989 9.52725 16.0849C9.72972 16.1109 9.86043 16.0917 10.5354 15.9369C10.8625 15.8618 11.1142 15.8127 11.1391 15.8189C11.1626 15.8248 11.2034 15.8464 11.2296 15.867C11.2801 15.9065 11.2887 15.9308 11.5291 16.7175C11.6518 17.1188 11.7385 17.3122 11.8664 17.4696C12.0577 17.705 12.3482 17.8916 12.6351 17.9633C12.8312 18.0123 13.1451 18.0122 13.3404 17.9631C13.7219 17.8671 14.0805 17.5842 14.2552 17.2415C14.2945 17.1643 14.3952 16.8721 14.5 16.5314C14.5978 16.2129 14.6911 15.9323 14.7072 15.9078C14.7233 15.8833 14.7658 15.8511 14.8015 15.8362C14.8641 15.8102 14.8871 15.814 15.4616 15.9475C16.1439 16.1061 16.3004 16.1241 16.5532 16.0732C16.9488 15.9935 17.2703 15.7798 17.4874 15.4523C17.6695 15.1776 17.7322 14.944 17.7169 14.5965C17.7066 14.3611 17.6754 14.2294 17.5871 14.0472C17.5007 13.8691 17.4362 13.7895 16.9918 13.3128C16.7745 13.0796 16.587 12.8672 16.5751 12.8408C16.5473 12.7791 16.5472 12.7134 16.5749 12.664C16.5869 12.6425 16.7709 12.4379 16.9838 12.2092C17.4246 11.7356 17.5007 11.6417 17.5861 11.4664C17.6906 11.2517 17.7122 11.1425 17.7121 10.8302C17.712 10.5652 17.7095 10.5453 17.6562 10.396C17.4909 9.93315 17.1545 9.61359 16.6778 9.46649C16.5651 9.43174 16.5025 9.42477 16.2998 9.42441C16.0591 9.424 16.0512 9.42531 15.4675 9.56219C14.9278 9.68874 14.8726 9.69852 14.8122 9.67836C14.7759 9.66626 14.7312 9.63619 14.713 9.61155C14.6947 9.58691 14.5982 9.30061 14.4986 8.97533C14.2892 8.29188 14.2349 8.17281 14.0373 7.96298C13.687 7.59104 13.2149 7.43476 12.7143 7.52494ZM12.7988 8.51653C12.7076 8.55865 12.6121 8.65238 12.5779 8.73338C12.5634 8.76788 12.4749 9.04612 12.3813 9.35168C12.2878 9.65725 12.187 9.95631 12.1575 10.0163C11.9558 10.4255 11.4686 10.7017 11.0172 10.6625C10.9477 10.6565 10.6284 10.591 10.3078 10.5169C9.98719 10.4428 9.70198 10.3822 9.67399 10.3822C9.59155 10.3822 9.43099 10.4509 9.36883 10.5129C9.33712 10.5445 9.29091 10.6137 9.26616 10.6666C9.22825 10.7476 9.2226 10.7807 9.23034 10.8767C9.23641 10.9519 9.25399 11.0145 9.28215 11.061C9.30558 11.0997 9.50295 11.3226 9.72075 11.5562C10.1512 12.018 10.2115 12.0921 10.2902 12.2567C10.4547 12.6003 10.4213 13.0661 10.2088 13.3909C10.1662 13.4561 9.94433 13.7098 9.7158 13.9547C9.48729 14.1995 9.28614 14.4294 9.26883 14.4655C9.22816 14.5502 9.21659 14.6905 9.24237 14.7858C9.29066 14.9644 9.48281 15.1135 9.66457 15.1135C9.71595 15.1135 10.0181 15.0536 10.342 14.9792C10.8509 14.8623 10.949 14.8449 11.0985 14.8448C11.3072 14.8447 11.4371 14.8756 11.6366 14.9728C11.834 15.0691 12.0494 15.2766 12.1454 15.463C12.1834 15.5368 12.2819 15.8245 12.3848 16.1619C12.4809 16.4774 12.5742 16.7637 12.592 16.7982C12.6578 16.9254 12.7874 17.0101 12.9403 17.0257C13.1222 17.0442 13.2993 16.952 13.3778 16.798C13.4003 16.7537 13.4965 16.4637 13.5914 16.1534C13.6956 15.8129 13.79 15.5395 13.8296 15.4634C13.9104 15.3082 14.1178 15.0971 14.2838 15.0009C14.4806 14.8869 14.617 14.8534 14.8778 14.8551C15.0921 14.8566 15.1287 14.8628 15.6518 14.9867C15.9634 15.0605 16.2406 15.1166 16.2929 15.1166C16.6332 15.1162 16.8518 14.7541 16.6916 14.4559C16.6691 14.4141 16.4726 14.1891 16.2548 13.9559C15.8448 13.517 15.7697 13.4263 15.6941 13.2793C15.5416 12.9828 15.5433 12.5296 15.6981 12.2255C15.7702 12.0839 15.8324 12.0093 16.2607 11.5506C16.4752 11.3209 16.6691 11.0989 16.6916 11.0572C16.8504 10.7632 16.6366 10.3989 16.3033 10.3956C16.2352 10.3949 16.0131 10.4391 15.6428 10.5269C15.1023 10.6551 15.0777 10.6593 14.8598 10.6589C14.6601 10.6586 14.6196 10.653 14.5 10.6096C14.3057 10.539 14.1867 10.463 14.0316 10.3105C13.8386 10.1208 13.7951 10.0265 13.5896 9.35122C13.4937 9.03605 13.4005 8.74919 13.3825 8.71376C13.3429 8.63555 13.2432 8.54565 13.1559 8.50933C13.066 8.47191 12.8875 8.47551 12.7988 8.51653ZM12.7476 11.2254C12.1027 11.3331 11.5924 11.8204 11.4641 12.4512C11.4242 12.6469 11.4393 13.0095 11.4948 13.1869C11.7211 13.9117 12.3989 14.3657 13.1402 14.2892C13.8432 14.2166 14.4114 13.6838 14.5196 12.9957C14.5451 12.8339 14.5298 12.5102 14.4899 12.3625C14.4494 12.2132 14.3358 11.9773 14.24 11.8436C13.9148 11.3898 13.2964 11.1337 12.7476 11.2254ZM12.8924 12.1948C12.7159 12.2206 12.537 12.3569 12.4627 12.5221C12.4058 12.6487 12.4047 12.8642 12.4604 12.985C12.552 13.184 12.7675 13.3213 12.9878 13.3213C13.342 13.3213 13.6138 12.9953 13.5459 12.6519C13.4848 12.3424 13.2078 12.1487 12.8924 12.1948Z"
        fill="currentColor"
      />
    </svg>
  );
}

export default function ChangeLanguage({ session }) {
  const [t, translations] = useTranslateLoader(prefixPN('changeLanguage'));
  const [store, render] = useStore({
    loading: false,
    locales: [],
    locale: session.locale,
  });
  const history = useHistory();

  async function load() {
    const { locales } = await getPlatformLocalesRequest();
    store.locales = map(locales, (locale) => ({ label: locale.name, value: locale.code }));
    render();
  }

  React.useEffect(() => {
    load();
  }, []);

  React.useEffect(() => {
    if (store.nextRenderAlert) {
      addSuccessAlert(t('success'));
      store.nextRenderAlert = false;
    }
  }, [JSON.stringify(translations)]);

  SocketIoService.useOn('USER_CHANGE_LOCALE', () => {
    store.nextRenderAlert = true;
  });

  async function save() {
    await updateUserRequest(session.id, { locale: store.locale }).catch((e) =>
      addErrorAlert(t('error', { error: e?.message ?? e }))
    );
  }

  return (
    <TotalLayoutContainer
      Header={
        <TotalLayoutHeader
          title={t('title')}
          onCancel={() => history.goBack()}
          icon={<HeaderIcon />}
          mainActionLabel={t('cancel')}
        />
      }
    >
      <Stack justifyContent="center">
        <TotalLayoutStepContainer
          Footer={
            <TotalLayoutFooterContainer rightZone={<Button onClick={save}>{t('save')}</Button>} />
          }
        >
          <Box>
            <ContextContainer title={t('interface')}>
              <Box style={{ maxWidth: 300 }}>
                <Select
                  label={t('selectLocale')}
                  data={store.locales}
                  value={store.locale}
                  onChange={(e) => {
                    store.locale = e;
                    render();
                  }}
                />
              </Box>
            </ContextContainer>
          </Box>
        </TotalLayoutStepContainer>
      </Stack>
    </TotalLayoutContainer>
  );
}

ChangeLanguage.propTypes = {
  session: PropTypes.object,
};
